<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi PWA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eee;
  text-align: center;
}

video, canvas {
  width: 100%;
  max-width: 420px;
  border-radius: 14px;
}

button {
  width: 100%;
  max-width: 420px;
  padding: 14px;
  font-size: 16px;
  margin-top: 10px;
  border: none;
  border-radius: 10px;
  background: #0d6efd;
  color: white;
}
</style>
</head>

<body>

<h3>üì∏ Absensi Foto</h3>

<video id="video" playsinline autoplay></video>
<button id="btnFoto">Ambil Foto</button>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const btnFoto = document.getElementById("btnFoto");

const params = new URLSearchParams(window.location.search);
const nama = params.get("nama") || "Nama Tidak Dikenal";

/* ===============================
   AUTO AKTIFKAN KAMERA DEPAN
================================ */
(async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    });
    video.srcObject = stream;
  } catch (e) {
    alert("‚ùå Kamera tidak bisa diakses");
  }
})();

/* ===============================
   AMBIL ALAMAT GRATIS
================================ */
async function getAlamat(lat, lng) {
  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
    );
    const d = await res.json();
    const a = d.address || {};
    return `${a.road || ""}, ${a.suburb || ""}
Kec. ${a.city_district || ""}
${a.city || a.town || ""}
${a.state || ""}`;
  } catch {
    return "Alamat tidak ditemukan";
  }
}

/* ===============================
   WRAP TEXT
================================ */
function wrapText(text, x, y, maxWidth, lineHeight) {
  const words = text.split(" ");
  let line = "";
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + " ";
    if (ctx.measureText(testLine).width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n] + " ";
      y += lineHeight;
    } else line = testLine;
  }
  ctx.fillText(line, x, y);
}

/* ===============================
   AMBIL FOTO
================================ */
btnFoto.onclick = () => {

  navigator.geolocation.getCurrentPosition(async pos => {

    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const alamat = await getAlamat(lat, lng);
    const waktu = new Date().toLocaleString("id-ID");

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // FOTO
    ctx.drawImage(video, 0, 0);

    // === LOGO KIRI ATAS ===
    const logo = new Image();
    logo.src = "logo.png";
    logo.onload = () => {
      const w = 90;
      const h = logo.height * (w / logo.width);
      ctx.drawImage(logo, 15, 15, w, h);
    };

    // === PANEL BAWAH ===
    const panelHeight = 200;
    ctx.fillStyle = "rgba(0,0,0,0.65)";
    ctx.fillRect(0, canvas.height - panelHeight, canvas.width, panelHeight);

    ctx.fillStyle = "#fff";
    ctx.font = "15px Arial";

    // === INFO KIRI ===
    let y = canvas.height - panelHeight + 30;
    ctx.fillText(`üë§ Nama : ${nama}`, 15, y); y += 24;
    ctx.fillText(`üïí Waktu : ${waktu}`, 15, y); y += 24;
    ctx.fillText(`üìç Koordinat : ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 15, y); y += 24;
    wrapText(`üè¢ ${alamat}`, 15, y, canvas.width - 160, 20);

    // === MAPS KANAN BAWAH ===
    const maps = new Image();
    maps.src = "maps.png";
    maps.onload = () => {
      const w = 120;
      const h = maps.height * (w / maps.width);
      ctx.drawImage(
        maps,
        canvas.width - w - 15,
        canvas.height - h - 20,
        w,
        h
      );
    };

    canvas.style.display = "block";

  }, err => alert("‚ùå GPS gagal"));
};
</script>

</body>
</html>
