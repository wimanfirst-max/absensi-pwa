<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Absensi PWA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #eee;
  text-align: center;
}

video, canvas {
  width: 100%;
  max-width: 420px;
  border-radius: 14px;
}

button {
  width: 100%;
  max-width: 420px;
  padding: 14px;
  font-size: 16px;
  margin-top: 10px;
  border: none;
  border-radius: 10px;
  background: #0d6efd;
  color: white;
}
</style>
</head>

<body>

<h3>üì∏ Absensi Foto</h3>

<video id="video" playsinline autoplay></video>
<button id="btnFoto">Ambil Foto</button>

<canvas id="canvas" style="display:none;"></canvas>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const btnFoto = document.getElementById("btnFoto");

const params = new URLSearchParams(window.location.search);
const nama = params.get("nama") || "Nama Tidak Dikenal";

/* ===============================
   AUTO KAMERA DEPAN
================================ */
(async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    });
    video.srcObject = stream;
  } catch {
    alert("‚ùå Kamera tidak bisa diakses");
  }
})();

/* ===============================
   ALAMAT GRATIS
================================ */
async function getAlamat(lat, lng) {
  try {
    const r = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`
    );
    const d = await r.json();
    const a = d.address || {};
    return `${a.road || ""}, ${a.suburb || ""}
Kec. ${a.city_district || ""}
${a.city || a.town || ""}
${a.state || ""}`;
  } catch {
    return "Alamat tidak ditemukan";
  }
}

/* ===============================
   TEXT WRAP
================================ */
function wrapText(text, x, y, maxWidth, lineHeight) {
  const words = text.split(" ");
  let line = "";
  for (let i = 0; i < words.length; i++) {
    const test = line + words[i] + " ";
    if (ctx.measureText(test).width > maxWidth && i > 0) {
      ctx.fillText(line, x, y);
      line = words[i] + " ";
      y += lineHeight;
    } else line = test;
  }
  ctx.fillText(line, x, y);
}

/* ===============================
   FOTO
================================ */
btnFoto.onclick = () => {

navigator.geolocation.getCurrentPosition(async pos => {

const lat = pos.coords.latitude;
const lng = pos.coords.longitude;
const alamat = await getAlamat(lat, lng);
const waktu = new Date().toLocaleString("id-ID");

canvas.width = video.videoWidth;
canvas.height = video.videoHeight;

// FOTO
ctx.drawImage(video, 0, 0);

// ===== LOGO (20% LEBIH BESAR) =====
const logo = new Image();
logo.src = "logo.png";
logo.onload = () => {
  const w = 110; // +20%
  const h = logo.height * (w / logo.width);
  ctx.drawImage(logo, 15, 15, w, h);
};

// ===== HITUNG TINGGI PANEL =====
ctx.font = "15px Arial";
const textLines = 6;
const lineHeight = 22;
const textHeight = textLines * lineHeight;

const mapsW = 130;
const mapsImg = new Image();
mapsImg.src = "maps.png";

mapsImg.onload = () => {

const mapsH = mapsImg.height * (mapsW / mapsImg.width);
const panelHeight = Math.max(textHeight + 30, mapsH + 30);

const panelY = canvas.height - panelHeight;

// ===== PANEL =====
ctx.fillStyle = "rgba(0,0,0,0.65)";
ctx.fillRect(0, panelY, canvas.width, panelHeight);

// ===== TEKS KIRI =====
ctx.fillStyle = "#fff";
let y = panelY + 30;
ctx.fillText(`üë§ Nama : ${nama}`, 15, y); y += lineHeight;
ctx.fillText(`üïí Waktu : ${waktu}`, 15, y); y += lineHeight;
ctx.fillText(`üìç Koordinat : ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 15, y); y += lineHeight;
wrapText(`üè¢ ${alamat}`, 15, y, canvas.width - mapsW - 40, lineHeight);

// ===== MAPS KANAN =====
ctx.drawImage(
  mapsImg,
  canvas.width - mapsW - 15,
  panelY + (panelHeight - mapsH) / 2,
  mapsW,
  mapsH
);

canvas.style.display = "block";
};

}, () => alert("‚ùå GPS gagal"));
};
</script>

</body>
</html>
